const API_KEY="daa03fdcd151c847dbb9e1008f179e84",API_BASE_URL="https://api.themoviedb.org/3",API_IMG_URL="https://image.tmdb.org/t/p/w500",movieAPI={latest_movies_url:API_BASE_URL+"/movie/now_playing?api_key="+API_KEY+"&language=en-US&page=1",search_movies_url:API_BASE_URL+"/search/movie?api_key="+API_KEY+"&language=en-US&page=1",top_movies_url:API_BASE_URL+"/movie/top_rated?api_key="+API_KEY+"&language=en-US&page=1"},BODY=document.body,MOVIES_FORM=document.querySelector(".form-search"),MOVIES_FORM_INPUT=document.querySelector("#txtSearchInput"),MOVIES_LIST_INFO=document.querySelector(".section-results-info"),MOVIES_LIST_EL=document.querySelector(".card-container"),MOVIES_TOTAL_RESULTS=document.querySelector(".results-total"),MOVIES_PAGE_PREV=document.querySelector("#cmdPrev"),MOVIES_PAGE_NEXT=document.querySelector("#cmdNext"),MOVIES_PAGE_INFO=document.querySelector(".results-page-info"),MOVIES_PAGER=document.querySelector(".block-pager"),MOVIES_ERR_EL=document.querySelector(".section-error"),MOVIES_ERR_MSG=document.querySelector(".section-error-message"),MOVIE_PANEL=document.querySelector(".panel-movie-info"),MOVIE_PANEL_DETAILS=document.querySelector(".panel-details"),MOVIE_CLOSE=document.querySelector(".btn-close"),MOVIE_HERO=document.querySelector(".content-hero"),MOVIE_HERO_IMG=document.querySelector("#divHeroImg"),MOVIE_BTN_TOP=document.querySelector(".btn-toprated");let TOTAL_PAGES=1,ACTIVE_PAGE=1,ACTIVE_SEARCH_URL="";const getJSON=(url,errorMsg)=>fetch(url).then(response=>{if(!response.ok)throw new Error(`${errorMsg} - ${response.status}`);return response.json()}),getMoviesList=async URL=>{ACTIVE_SEARCH_URL=URL,MOVIES_ERR_EL.style.display="none",MOVIES_LIST_INFO.style.display="flex",await getJSON(URL,"Movie List - cannot get the movie list").then(data=>{renderMovieList(data.results),ACTIVE_PAGE=data.page,TOTAL_PAGES=data.total_pages;let totalResults=data.total_results;MOVIES_TOTAL_RESULTS.innerHTML=totalResults,MOVIES_PAGER.style.display=0===totalResults?"none":"flex",1===ACTIVE_PAGE?MOVIES_PAGE_PREV.classList.add("is-inactive"):MOVIES_PAGE_PREV.classList.remove("is-inactive"),ACTIVE_PAGE===TOTAL_PAGES?MOVIES_PAGE_NEXT.classList.add("is-inactive"):MOVIES_PAGE_NEXT.classList.remove("is-inactive"),MOVIES_PAGE_INFO.innerHTML="Page "+ACTIVE_PAGE+" of "+TOTAL_PAGES}).catch(err=>{renderError(err.message)})},renderMovieList=movieListData=>{let output="";MOVIE_HERO.style.display="none",movieListData.forEach((movie,index)=>{const{id:id,title:title,release_date:release_date,poster_path:poster_path}=movie,yearRelease=getYear(release_date),posterImg=null!=poster_path?API_IMG_URL+"/"+poster_path:"assets/main/img/layout/empty-poster.jpg";0===index&&renderHeroMovie(movie),output+=`\n\t\t\t<div class="cell">\n\t\t\t\t<a href="" class="card-movie" onclick="movieHandler(${id}, event)">\n\t\t\t\t\t<span class="img" style="background-image:url(${posterImg});"></span>\n\t\t\t\t\t<span class="info">\n\t\t\t\t\t\t<span class="title">${title}</span>\n\t\t\t\t\t\t<span class="year">${yearRelease}</span>\n\t\t\t\t\t</span>\n\t\t\t\t</a>\n\t\t\t</div> \n    `}),MOVIES_LIST_EL.innerHTML="",MOVIES_LIST_EL.insertAdjacentHTML("beforeend",output)},renderMovie=(details,credits)=>{const{title:title,overview:overview,backdrop_path:backdrop_path,vote_average:vote_average,release_date:release_date,genres:genres,imdb_id:imdb_id,runtime:runtime}=details,yearRelease=getYear(release_date),genreData=genres.map(item=>item.name),directors=credits.crew.filter(item=>"Director"===item.job),cast=credits.cast.map(item=>{if("Acting"===item.known_for_department)return item.name});let movieSpecifics="",creditDirs=[],creditCast=cast.slice(0,3);directors.forEach(item=>{creditDirs.push(item.name)}),creditDirs.length>0&&(movieSpecifics+="<li><strong>Director</strong>: "+creditDirs.join(", ")+"</li>"),creditCast.length>0&&(movieSpecifics+="<li><strong>Cast</strong>: "+creditCast.join(", ")+"</li>"),genreData.length>0&&(movieSpecifics+="<li><strong>Genre</strong>: "+genreData.join(", ")+"</li>");const posterImg=null!=backdrop_path?API_IMG_URL+backdrop_path:"assets/main/img/layout/empty-back.jpg";let output="";output+=`\n\t\t<h3 class="movie-title">${title}</h3>\n\t\t<p class="movie-release">${yearRelease} | ${runtime} mins</p>\n\t\t<div class="movie-img" style="background-image:url('${posterImg}');"></div>\n\t\t<div class="movie-teaser">\n\t\t\t<p>${truncateString(overview,500)}</p>\n\t\t\t<ul>\n\t\t\t\t${movieSpecifics}\n\t\t\t\t<li><strong>IMDB rating</strong>: ${vote_average}/10 | <a target="_blank" href="https://www.imdb.com/title/${imdb_id}/">read more on IMDB <span class="mmt-icon-imdb"></span></a></li>\n\t\t\t</ul>\n\t\t</div>\t\t\t\n   `,BODY.classList.add("oflow"),MOVIE_PANEL_DETAILS.innerHTML="",MOVIE_PANEL_DETAILS.insertAdjacentHTML("beforeend",output),MOVIE_PANEL.classList.add("is-open")},renderHeroMovie=movie=>{let output="";const{title:title,release_date:release_date,backdrop_path:backdrop_path,overview:overview}=movie,yearRelease=getYear(release_date),imgBackground=null!=backdrop_path?API_IMG_URL+backdrop_path:"assets/main/img/layout/empty-back.jpg";output=`\n\t\t<p class="highlite">List highlite</p>\n\t\t<h1>${title}</h1>\n\t\t<p class="info">${truncateString(overview,165)}</p>\n\t\t<p class="date">Released: ${yearRelease}</p>\n\t`,MOVIE_HERO_IMG.style.backgroundImage='url("'+imgBackground+'")',MOVIE_HERO.innerHTML="",MOVIE_HERO.insertAdjacentHTML("beforeend",output),MOVIE_HERO.style.display="block"},movieHandler=(movieID,e)=>{e.preventDefault();const movieCreditsURL=API_BASE_URL+"/movie/"+movieID+"/credits?api_key="+API_KEY+"&language=en-US",movieURL=API_BASE_URL+"/movie/"+movieID+"?api_key="+API_KEY+"&language=en-US";Promise.all([getJSON(movieCreditsURL,"Movie Credits - cannot get the credits"),getJSON(movieURL,"Movie Info - cannot get the movie information")]).then(([credits,details])=>{renderMovie(details,credits)})},renderError=errorMessage=>{MOVIES_ERR_MSG.innerHTML=errorMessage,MOVIES_ERR_EL.style.display="flex",MOVIES_LIST_INFO.style.display="none",console.log(errorMessage)},updateQSParameter=(url,key,value)=>{let re=new RegExp("([?&])"+key+"=.*?(&|$)","i"),sep=-1!==url.indexOf("?")?"&":"?";return url.match(re)?url.replace(re,"$1"+key+"="+value+"$2"):url+sep+key+"="+value},handlePaging=newpage=>{let url=updateQSParameter(ACTIVE_SEARCH_URL,"page",newpage);getMoviesList(url)},getYear=date=>{const dtRelease=new Date(date),yearRelease=dtRelease.getFullYear();return yearRelease},truncateString=(s,n)=>s.length>n?s.substr(0,n-1)+"&hellip;":s,closePanel=()=>{MOVIE_PANEL.classList.remove("is-open"),BODY.classList.remove("oflow")};MOVIES_FORM.addEventListener("submit",e=>{e.preventDefault();let inputText=MOVIES_FORM_INPUT.value.trim();MOVIES_FORM_INPUT.value="",MOVIE_BTN_TOP.classList.remove("is-active"),getMoviesList(inputText?movieAPI.search_movies_url+"&query="+inputText:movieAPI.latest_movies_url)}),MOVIES_PAGE_NEXT.addEventListener("click",e=>{e.preventDefault();let nextPage=ACTIVE_PAGE+=1;nextPage<=TOTAL_PAGES&&handlePaging(nextPage)}),MOVIES_PAGE_PREV.addEventListener("click",e=>{e.preventDefault();let prevPage=ACTIVE_PAGE-=1;prevPage>=1&&handlePaging(prevPage)}),MOVIE_CLOSE.addEventListener("click",e=>{e.preventDefault(),closePanel()}),MOVIE_BTN_TOP.addEventListener("click",e=>{e.preventDefault(),getMoviesList(movieAPI.top_movies_url),MOVIE_BTN_TOP.classList.add("is-active")}),document.addEventListener("click",e=>{e.target.closest(".panel-movie-info .content")||closePanel()}),getMoviesList(movieAPI.latest_movies_url);